# Analyzing Evil With Sysmon & Event Logs

https://academy.hackthebox.com/module/216/section/2301

**System Monitor (Sysmon)** is a Windows system service and device driver that
remains resident across system reboots to monitor and log system activity to the Windows event log.
Sysmon provides detailed information about process creation, network connections, changes to file creation time, and more. \
Includes:

- A Windows service for monitoring system activity.
- A device driver that assists in capturing the system activity data.
- An event log to display captured activity data.

Docs and Event IDs: https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon#events \
XML Config: https://github.com/SwiftOnSecurity/sysmon-config \
Download: https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon

Install command

```ps
sysmon.exe -i -accepteula -h md5,sha256,imphash -l -n
```

Use custom config

```ps
sysmon.exe -c filename.xml
```

Once config updated, to view these events, navigate to the Event Viewer and access "Applications and Services" -> "Microsoft" -> "Windows" -> "Sysmon."

# Lab

1. Replicate the DLL hijacking attack described in this section and provide the SHA256 hash of the malicious WININET.dll as your answer. "C:\Tools\Sysmon" and "C:\Tools\Reflective DLLInjection" on the spawned target contain everything you need.

<details>
<summary>Guide</summary>
  
cd into Tools\Sysmon and edit the configuration provided. Change "include" to "exclude" to not exclude imageload events (???).
![image](https://github.com/matt-rog/doc/assets/91029371/69cdb9b8-92ad-482d-97d5-3d3e4f91b630) \
Load the config
```
sysmon.exe -c sysmonconfig-export.xml
```
Go to C:\Tools\Reflective DLLInjection. Here is the rdi kit from https://github.com/stephenfewer/ReflectiveDLLInjection/tree/master \
Rename `reflective_dll.x64.dll` to `WININET.dll` and move it and **copy** `calc.exe` to the same writable directory. (WININET is a dll hijackable by calc.exe) \
Start that `calc.exe` and you'll start the injected message box process. (this is all just following the module guide) \
Used this xml filter to see the event generated by WININET.dll
```xml
<QueryList>
  <Query Id="0" Path="Microsoft-Windows-Sysmon/Operational">
    <Select Path="Microsoft-Windows-Sysmon/Operational">
	*[System[(EventID=7)]] and *[EventData[Data[@Name='ImageLoaded'] and (Data='C:\Users\Administrator\Desktop\Reflective DLLInjection\WININET.dll')]]
    </Select>
  </Query>
</QueryList>
```
It returns one event log.
</details>
<details>
<summary>Answer</summary>
51F2305DCF385056C68F7CCF5B1B3B9304865CEF1257947D4AD6EF5FAD2E3B13
</details>

2. Replicate the Unmanaged PowerShell attack described in this section and provide the SHA256 hash of clrjit.dll that spoolsv.exe will load as your answer. "C:\Tools\Sysmon" and "C:\Tools\PSInject" on the spawned target contain everything you need.

<details>
<summary>Guide</summary>

Literally just following the guide, start "Process Hacker" from the search bar. Open powershell, run the following (line by line). Be sure to put in your process ID.

```ps
 powershell -ep bypass
 Import-Module .\Invoke-PSInject.ps1
 Invoke-PSInject -ProcId [Process ID of spoolsv.exe] -PoshCode "V3JpdGUtSG9zdCAiSGVsbG8sIEd1cnU5OSEi"
```

Give it a couple seconds and in process hacker you should see the spoolsv.exe process turn green, meaning its managed.\
To find the event, run this xml filter. I got the locations of what to filter for from the guide + question.

```xml
<QueryList>
  <Query Id="0" Path="Microsoft-Windows-Sysmon/Operational">
    <Select Path="Microsoft-Windows-Sysmon/Operational">
	*[System[(EventID=7)]] and  *[EventData[Data[@Name='Image'] and (Data='C:\Windows\System32\spoolsv.exe')]]
 and *[EventData[Data[@Name='ImageLoaded'] and (Data='C:\Windows\Microsoft.NET\Framework64\v4.0.30319\clrjit.dll')]]
    </Select>
  </Query>
</QueryList>
```

You'll get one event, pull the SHA from there.

</details>
<details>
<summary>Answer</summary>
8A3CD3CF2249E9971806B15C75A892E6A44CCA5FF5EA5CA89FDA951CD2C09AA9
</details>

3. Replicate the Credential Dumping attack described in this section and provide the NTLM hash of the Administrator user as your answer. "C:\Tools\Sysmon" and "C:\Tools\Mimikatz" on the spawned target contain everything you need.

<details>
<summary>Guide</summary>

Via cmd line, go the the directory of the Mimikatz tool "\Tools\Mimikatz" and then start the executable in that folder, `AgentEXE.exe`. \
The Mimikatz tool will prompt you to run modules. \
Run the `privilege::debug` module and then the `sekurlsa::logonpasswords` module. \
The output of the last module will contain the hashes for the admin credentials. \ The NTLM is the flag.

</details>
<details>
<summary>Answer</summary>
5e4ffd54b3849aa720ed39f50185e533
</details>
